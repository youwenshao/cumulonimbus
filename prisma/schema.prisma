generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String         @id @default(cuid())
  email                String         @unique
  password             String
  name                 String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  lmstudioEndpoint     String?        @default("http://localhost:1234")
  lmstudioModel        String?        @default("local-model")
  ollamaEndpoint       String?        @default("http://localhost:11434")
  ollamaModel          String?        @default("qwen3-coder:30b")
  ollamaSmallModel     String?        @default("qwen3:4b")
  preferredLLMProvider String?        @default("auto")
  
  // Subscription fields
  plan                 Plan           @default(FREE)
  subscriptionStatus   String?        @default("ACTIVE")
  subscriptionPeriod   String?        @default("MONTHLY")
  stripeCustomerId     String?
  stripeSubscriptionId String?

  apps                 App[]
  conversations        Conversation[]
}

model App {
  id                 String      @id @default(cuid())
  userId             String
  name               String
  description        String
  spec               Json
  config             Json
  data               Json        @default("[]")
  status             AppStatus   @default(DRAFT)
  generatedCode      Json?
  generationLog      Json?
  buildStatus        BuildStatus @default(PENDING)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  version            String?     @default("v1")
  componentFiles     Json?
  layoutDefinition   Json?
  bundledCode        String?
  executionMode      String?     @default("schema")
  sandboxPermissions Json?
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Conversation {
  id                String            @id @default(cuid())
  userId            String
  appId             String?
  messages          Json              @default("[]")
  phase             ConversationPhase @default(PARSE)
  spec              Json?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  version           String?           @default("v1")
  agentState        Json?
  schemaDesigns     Json?             @default("[]")
  layoutDesigns     Json?             @default("[]")
  refinementHistory Json?             @default("[]")
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([appId])
}

enum AppStatus {
  DRAFT
  GENERATING
  ACTIVE
  ARCHIVED
}

enum BuildStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

enum ConversationPhase {
  PARSE
  PROBE
  PICTURE
  PLAN
  COMPLETE
}

enum Plan {
  FREE
  PLUS
  PRO
}
