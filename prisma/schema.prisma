generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                   String         @id @default(cuid())
  email                String         @unique
  password             String
  name                 String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  lmstudioEndpoint     String?        @default("http://localhost:1234")
  lmstudioModel        String?        @default("local-model")
  ollamaEndpoint       String?        @default("http://localhost:11434")
  ollamaModel          String?        @default("qwen3-coder:30b")
  ollamaSmallModel     String?        @default("qwen3:4b")
  preferredLLMProvider String?        @default("auto")
  
  // User API Keys (encrypted)
  deepseekApiKey       String?        // Encrypted DeepSeek API key
  openrouterApiKey     String?        // Encrypted OpenRouter API key
  
  // Advanced LLM Settings
  manualModelSelection Boolean        @default(false)
  manualOllamaModel    String?        // Manually selected Ollama model
  manualLMStudioModel  String?        // Manually selected LM Studio model
  
  // Subscription fields
  plan                 String           @default("FREE")
  subscriptionStatus   String?        @default("ACTIVE")
  subscriptionPeriod   String?        @default("MONTHLY")
  stripeCustomerId     String?
  stripeSubscriptionId String?

  apps                 App[]
  conversations        Conversation[]
}

model App {
  id                 String      @id @default(cuid())
  userId             String
  name               String
  description        String
  spec               String      // V2: { schema, layout, components }
  config             String
  data               String        @default("[]")
  status             String   @default("DRAFT")
  generatedCode      String?
  generationLog      String?
  buildStatus        String @default("PENDING")
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  version            String?     @default("v2")  // Default to V2 scaffolder
  componentFiles     String?     // V2: Modular component files
  layoutDefinition   String?     // V2: Layout DSL definition
  
  // V3 Scaffolder fields
  scaffoldVersion    String?     // "v3" for V3 apps
  scaffoldId         String?     @default("vite-react-shadcn")  // Scaffold template ID
  viteComponentFiles String?     // V3: JSON Record<string, string> of file paths to content
  vitePackageJson    String?     // V3: JSON package.json contents
  viteScaffoldConfig String?     // V3: JSON scaffold metadata
  
  // Nebula Hosting fields
  subdomain          String?     @unique
  isAlwaysOn         Boolean     @default(false)
  lastActivity       DateTime    @default(now())
  
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, version])
}

model Conversation {
  id                String            @id @default(cuid())
  userId            String
  appId             String?
  messages          String              @default("[]")
  phase             String @default("intent")  // V2 phases: intent, design, refine, finalize
  spec              String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  version           String?           @default("v2")  // Default to V2 scaffolder
  agentState        String?           // V2: DynamicConversationState
  schemaDesigns     String?             @default("[]")
  layoutDesigns     String?             @default("[]")
  refinementHistory String?             @default("[]")
  
  // V3 Scaffolder fields
  agentToolHistory    String?           @default("[]")  // V3: Tool execution log
  componentFilesCache String?           // V3: Cached file system state during conversation
  
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([appId])
  @@index([userId, version])
  @@index([userId, updatedAt])
}

// Enum String converted to String

// Enum String converted to String

// Enum String converted to String

// Enum String converted to String
